# Promotion process

### Assumptions and Considerations
* Any pull request activity requires branches - source and target. This will result in multiple branches no matter of repository structure used (folder based, branch based, etc.). Branch based repository will have branch structure pre-defined.
* Development activity will be targeting ProvingGround environment only. Changes to be submitted as pull requests to the main branch.
* All other environments / clusters are not to be accessed directly by Developers - only by pipeline actions
* Promotion Stop gates are implemented as pull requests. Pull request review, approval or decline by operations/SME/Management will accomplish it.
* Automated stop gate approval can be implemented as pipeline actions.

### Proposal - separate repositories for each environment
* ProvingGround - the only one accessible to Developers.
* Learning
* Engineering
* Platform

Option - to address SOC2 requirement and centralize Github workflow development process:
* Workflow repository - to host all workflows
* All other repositories to be sourced as subtree's or submodules in the Workflow repository.

### Proposal - Branch structure in each repository to support promotion process
* main branch - to serve as a baseline for each environment
* Cluster specific branches - to integrate with Terraform Cloud workspaces (one branch per workspace). E.g:
  * EastUS01
  * EastUS02
  * WestUS01
* promotion branches - to serve for promotion delivery and acceptance. E.g.
  * from_provinggrounds (in Learning repository) - to accept approved changes from ProvingGrounds environment repository. Changes will be submitted as pull request to the main branch as a stop gate (with option to automatically accept them). Alternative - all changes are submitted directly to the main branch.
  * to_engineering (in Learning repository) - to promote approved changes to the Engineering environment repository (from_learning (or main) branch).

### Development process
* Developers work off of main branch in ProvingGround repository. Changes are to be submitted as pull requests to the main branch in ProvingGround repository.
* Administrators/Ops - to review and approve/decline pull requests in main branch in ProvingGround repository.
* Other repositories/branches are not to be touched by developers 

TBD: enforce via branch protection/actions, allow direct changes? - how to merge/backport

### Promotion process
* All promotion activities to be done via GitHub workflows.
* Pull requests to be used as stop gates in the promotion process.
* Administrators/Operations/Management - to review and approve/decline pull requests generated by GitHub workflows.

TBD: Need to review pr rejection process - how to promote back to lower environments (manually or another set of GitHub workflows)

### Promotion process details
Example based on two environments:
* ProvingGrounds
* Learning

#### Activities:
* Operations/SRE to create issues in ProvingGround repo (optionally)
* Developers clone/fork main branch of ProvingGround repo
* Developers make changes and submit them as pull requests to the main branch of ProvingGround repo optionally linking pull requests to issues
* Developers to make additional commits to pull request as required by reviewer
* Operations to review pull requests, request changes, approve or decline pull requests.
* Github workflow (on push to main branch of ProvingGround repo) - execute the following steps:
  * validate changes (using pre-commit, clarity or/and hashicorp/setup-terrafom action)
    * Notify and Exit on validation failure
  * create pull request to the following branches:
    * cluster specific branches - to submit changes to corresponding Terraform workspaces
      * EastUS01
      * EastUS02
      * WestUS01
    * to_learning branch - to promote changes to Learning environment
* Operations or GitHub workflow (on pull request) to approve pull requests on cluster specific branches to initiate deployment
  * GitHub workflow (on pull request approval (push) on each cluster branch) to initiate Terraform deployment using hashicorp/setup-terrafom action
  * Or current VCS integration process 
* Operations to approve pull request on promotion (to_learning) branch to initiate promotion to the Learning environment
  * TBD: Consider automating detection of Terraform deployment process success to initiate pull request approval promoting changes to the Learning environment
* GitHub workflow (on pull request approval/push to the to_learning branch)
  * Copy files from to_learning branch in ProvingGround repository to the from_provingground branch in Learning repository
  * Commit changes and create pull request in the from_provingground branch in Learning repository
* Operator or GitHub Workflow (on pull request in from_provingground branch in Learning repo) to approve pull request
* GitHub Workflow (on pull request approval (push) in from_provingground branch in Learning repo) to push changes to the main branch in Learning repo
* Process in the Learning repo to continue same way as above.
